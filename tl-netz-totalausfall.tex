%% tl-netz-totalausfall.tex
\chapter{Totalausfall des Netzes}
\label{cha:netz-totalausfall}

\begin{abstractsec}
  Habe ich an einem Rechner überhaupt keine Netzverbindung, oder kann ich ein
  ganzes Netzsegment nicht erreichen, spreche ich von einem Totalausfall.
\end{abstractsec}

\section{Ein Rechner hat überhaupt keine Netzverbindung}
\label{sec:gar-kein-netz}

\begin{abstractsec}
  Dieser Abschnitt beschäftigt sich mit dem Totalausfall des Netzwerks an
  einem Rechner.
\end{abstractsec}
\begin{normaltext}
  Manchmal kommt es vor, dass ein Rechner überhaupt keine Netzwerkverbindung
  hat. Dann bleibt nichts übrig, als dem Problem methodisch auf den Grund zu
  gehen. Dazu verwende ich den folgenden Entscheidungsbaum, um das Problem in
  Teilprobleme zu zerlegen:

\begin{tikzpicture}
[every node/.style={fill=black!10,rounded corners,align=center},
grow=south, level distance=2cm,
level 1/.style={sibling distance=3cm},
level 2/.style={sibling distance=3cm},
]

\node{Funktioniert die Bitübertragungsschicht?}
  child{node[draw,fill=white]{Hardwareproblem}
  edge from parent node[fill=black!10]{nein}}
  child{node at +(1,-1) {Hat der Rechner korrekte IP-Adressen?}
    child{node[draw,fill=white]{Schnittstellenkonfiguration}
    edge from parent node{nein}}
    child{node at +(1,-1) {Funktionieren einfache Dienste?}
      child{node[draw,fill=white]{Paketfilterregeln}
      edge from parent node{nein}}
      child{node at +(1,-1) {Kein Totalausfall}
      edge from parent node{ja}}
    edge from parent node{ja}}
  edge from parent node{ja}};
\end{tikzpicture}

  Die allererste Frage geht dabei nach der physischen Netzverbindung, im
  OSI-Modell auch Bitübertragungsschicht genannt. Bei Hardware-Rechnern mit
  einigermaßen neuer Netzwerkkarte helfen mir die mii-tools beziehungsweise
  eth-tools, die Auskunft über die Verbindungsparameter zum Switch geben
  können. Habe ich es mit einer virtuellen Maschine zu tun, dann muss ich am
  Hostsystem die Netzwerkeinstellungen für diese VM kontrollieren.

  Auch das Programm ifconfig zeigt an, ob das betreffende Interface eine
  physikalische Verbindung hat (\verb?RUNNING?). Noch deutlicher zeigt  es
  \verb?ip link show? beziehungsweise \verb?ip addr show? (\verb?LOWER_UP?
  oder \verb?NO-CARRIER?).

  Habe ich diese Programme nicht zur Verfügung, kann ich mich vielleicht mit
  \verb?netstat -i? behelfen. Dieser Befehl zeigt eine Statistik der
  gesendeten und empfangenen Pakete an. Da in jedem Netzwerk ein gewisser
  Anteil an Broadcastpaketen unterwegs ist, sollte sich die Anzahl der
  empfangenen Datenpakete erhöhen, wenn ich den Befehl im Abstand von einigen
  Sekunden aufrufe. Um sicher zu gehen, kann ich auf einem anderen Rechner im
  gleichen Netzsegment zum Beispiel mit ping Broadcastpakete erzeugen.

  Wenn tcpdump installiert ist, kann ich auch mit
  \verb?tcpdump -n -i <schnittstelle>? auf Traffic warten. Wenn ich damit
  Traffic sehe, beende ich das Programm nicht gleich, sondern warte, bis ich
  an Hand der Datenpakete entscheiden kann, ob die Schnittstelle im richtigen
  Segment angeschlossen ist.

  Kann ich keinen Traffic nachweisen, muss ich mir die Verkabelung ansehen,
  probeweise die Kabel tauschen, den Rechner an einen anderen Switch
  anschließen und/oder in ein anderes Netzsegment. Bei virtuellen Maschinen
  schaue ich auf dem Host nach, ob andere VM ähnliche Probleme haben, ob
  vielleicht ein falscher Netzwerkanschluß zugewiesen wurde oder kontrolliere
  die entsprechenden virtuellen Interfaces auf dem Host.

  Ein kurzer Test mit \verb?iptables -L? und \verb?ebtables -L? sagt mir, ob
  vielleicht Paketfilterregeln die Verbindung unterdrücken.

  Erst wenn die Bitübertragungsschicht funktioniert, hat es überhaupt Sinn,
  sich dem nächsten Problem, der IP-Konfiguration zuzuwenden. Diese muss zum
  angeschlossenen Netzsegment passen. Eventuell ist es besser, für die Dauer
  der Fehlersuche, alle Regeln zu entfernen und die Policies auf \verb?ACCEPT?
  zu stellen.

  Habe ich vorher die Funktionalität der Schnittstelle mit tcpdump
  kontrolliert, dann habe ich eventuell schon genügend Pakete gesehen, die mir
  zeigen, ob die Schnittstelle im richtigen Segment angeschlossen ist.
  Ansonsten kann ich das jetzt nachholen.

  Habe ich tcpdump nicht an Board, weiß aber, dass DHCP im Netzwerk zur
  Verfügung steht, kann ich versuchen darüber eine IP-Adresse zu bekommen.
  Dazu stelle ich temporär die Schnittstellenkonfiguration um. Falls ich es
  noch nicht getan habe, deaktiviere ich jetzt alle Paketfilter.

\begin{Exkursbox}{Konfiguration der Netzwerkschnittstelle}
  Bei Debian: /etc/network/interfaces

  Bei Redhat: /etc/sysconfig/network-scripts/*
\end{Exkursbox}

  Kann ich DHCP nicht nutzen, so könnte ich noch versuchen mit Zero
  Configuration Networking zu anderen Rechnern in meinem Segment zu bekommen.
  Das hängt davon ab, wie das betreffende Netzwerk administriert ist.

  Habe ich nicht die Möglichkeit für Tests mit DHCP/Zero Configuration
  Networking, kann ich versuchen mit Ping bekannte und aktive Stationen in
  meinem Netzsegment zu erreichen. Antworten die Stationen nicht, aber ihre
  IP-Adressen tauchen korrekt im ARP-Cache auf (Test mit \verb?arp -an?), dann
  liegt das Problem eher an zu restriktiven Paketfiltereinstellungen der
  anderen Rechner und ich würde diese dort testweise lockern beziehungsweise
  auf den anderen Rechnern mit tcpdump oder Wireshark nachschauen, ob ich
  Datenpakete des problematischen Rechners sehen kann. Bei VMs kann ich mit
  tcpdump am zugehörigen virtuellen Interface des Hosts nachschauen.

\begin{Exkursbox}{Sperren von ICMP durch Paketfilter}
  Verweis auf übermäßiges Beschränken von ICMP-Verkehr und die Auswirkungen
  auf den Netzverkehr.
\end{Exkursbox}

Habe ich mich davon überzeugt, dass der Rechner im richtigen Netzsegment
angeschlossen ist und Stationen in diesem erreichen kann, muss ich mich nur
noch vergewissern, dass er Rechner in anderen Netzen erreichen kann.

Bei der Überprüfung der Schnittstellenkonfiguration, habe ich mich gleich mit
vergewissert, dass der Rechner das richtige Gateway kennt. Ich überzeuge mich
davon, dass die konfigurierte Konfiguration auch aktiv ist. Insbesondere
überprüfe ich:

\begin{itemize}
  \item Stimmen IP-Adresse und Netzmaske? (\verb?ip addr show?)
  \item Stimmen Gateway und Routen? (\verb?ip route show?)
  \item Kann ich das Gateway erreichen? (\verb?ping $gateway?)
\end{itemize}

\begin{Exkursbox}{Netzmasken}
  Hier in Tabellenform oder ähnlich eine Übersicht zu IPv4-Netzmasken.
\end{Exkursbox}

Anschließend versuche ich mit ping einen Rechner in einem anderen
Netzsegment zu erreichen, der zum Beispiel von anderen Stationen
aus diesem Segment erreicht werden kann. Kann ich trotz korrekter
IP-Konfiguration und deaktiviertem Paketfilter auf dem Problemrechner keine
Rechner in anderen Segmenten erreichen, muss ich auf dem Gateway nachsehen, ob
die Datenpakete des Problemrechners dort vorbeikommen. Sehe ich diese am
Gateway, kann ich den Problemrechner bei der Fehlersuche hinter mir lassen,
vielleicht noch einen Dauerping einschalten und muss mich bei der Problemsuche
dem Netz zuwenden.

\end{normaltext}

%\subsection{Seiteneffekte}
%\label{sec:seiteneffekte}

%\subsection{Einschränkung der Umsetzung}
%\label{sec:einschr-der-umsetz}

%\begin{notes}
%\item Was nicht geht
%\item geht auch nicht
%\item und auch das
%\end{notes}

\section{Ein oder mehrere Netzsegmente sind nicht erreichbar}
\label{sec:ausfall-netzsegment}

\begin{notes}
\item Entscheidungsbaum!
\end{notes}

\subsection{Routen zu diesen Netzen fehlen}
\label{sec:routen fehlen}

\begin{notes}
\item Routingprotokolle
\item OSPF: BDR hatte falschen Neighbor (openbsd, GeNUScreen)
\item Routersoftware quagga
\end{notes}

\subsection{Rückroute fehlt}
\label{sec:rueckroute-fehlt}

\begin{notes}
\item Problem: Routen scheinen zu stimmen, keine Antwortpakete
\item Analyse: traceroute, analyse des letzten Hops und desjenigen danach
\item Ursache: Rückroute fehlt
\end{notes}

%\subsection{Schnittstelle zu B}
%\label{sec:schnittstelle-zu-b}

%\begin{notes}
%\item Syntax
%\item Semantik
%\end{notes}


%%% Local Variables: 
%%% mode: latex
%%% TeX-master: "arbeit-hauptdatei"
%%% End: 
%%% vim: set sw=2 ts=2 tw=78 et si:
